<script type="text/javascript">
    function decodeMessage(eventHandler) {
        return function (e) {
            try {
                const decoded = JSON.parse(e.data);
                eventHandler(decoded);
            } catch (err) {
                eventHandler({ action: 'error', agrs: { err, eventHandler: eventHandler } });
            }
        };
    }

    function bindEvent(element, eventName, eventHandler) {
        if (element.addEventListener) {
            element.addEventListener(eventName, decodeMessage(eventHandler), false);
        } else if (element.attachEvent) {
            element.attachEvent(`on${eventName}`, decodeMessage(eventHandler));
        }
    }

    // Send a message to the parent
    function sendToParent(action, data) {
        const encoded = JSON.stringify({
            action,
            agrs: data,
        });
        // Make sure you are sending a string, and to stringify JSON
        console.log('sendToParent', action, data);
        window.parent.postMessage(encoded, '*');
    };

    function needLogin() {
        if (window.location.href.indexOf('sign-in') > -1) {
            sendToParent('need-login', {});
            setTimeout(needLogin, 1000);
        } else {
            console.log('no need login');
        }
    }

    function hashChanged() {
        if (window.location.href.indexOf('sign-in') > -1) {
            needLogin();
        }
    }

    function loginAction(data) {
        if (window.location.href.indexOf('sign-in') > -1) {
            console.log('at login page');
            const email = document.getElementById('at-field-username_and_email');
            const pwd = document.getElementById('at-field-password');
            const form = document.getElementById('at-pwd-form');
            if (form && email && pwd) {
                console.log('login detected');
                email.value = data.email;
                pwd.value = data.pwd;
                try {
                    form.submit();
                } catch (err) {
                    sendToParent('error', { message: 'fail submit' });
                }
            } else {
                console.error('fail to get form, pwd or email', form, email, pwd);
                sendToParent('error', { message: 'fail to get form, pwd or email' });
            }
        } else {
            console.error('not on login page');
        }
    }

    function initMessagesIframe() {
        // Listen to messages from parent window
        bindEvent(window, 'message', function (data) {
            console.log('message in iframe', data);
            // if (e.data ===)
            if (data.action === 'login') {
                loginAction(data);
            }
        });
        if (FlowRouter) {
            hashChanged();
            FlowRouter.subscriptions = function () {
                console.log('routeee');
                hashChanged();
            };
        }
        sendToParent('inited', {});
        needLogin();
    }

    $(document).ready(function () {
        initMessagesIframe();
    });
</script>
</body>