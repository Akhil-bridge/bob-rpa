<script type="text/javascript">
    function decodeMessage(eventHandler) {
        return function (e) {
            try {
                const decoded = JSON.parse(e.data);
                eventHandler(decoded);
            } catch (err) {
                eventHandler({ action: 'error', agrs: {} });
            }
        };
    }

    function bindEvent(element, eventName, eventHandler) {
        if (element.addEventListener) {
            element.addEventListener(eventName, decodeMessage(eventHandler), false);
        } else if (element.attachEvent) {
            element.attachEvent(`on${eventName}`, decodeMessage(eventHandler));
        }
    }

    // Send a message to the parent
    function sendToParent(action, data) {
        const encoded = JSON.stringify({
            action,
            agrs: data,
        });
        // Make sure you are sending a string, and to stringify JSON
        window.parent.postMessage(encoded, '*');
    };

    function needLogin() {
        if (window.location.href.indexOf('sign-in') > -1) {
            sendToParent('need-login', {});
            setTimeout(needLogin, 1000);
        } else {
            console.log('no need login');
        }
    }

    function initMessagesIframe() {

        // Listen to messages from parent window
        bindEvent(window, 'message', function (data) {
            console.log('message in iframe', data);
            // if (e.data ===)
            if (data.action === 'login' && window.location.href.indexOf('sign-in') > -1) {
                console.log('at login page');
                const email = document.getElementById('at-field-username_and_email');
                const pwd = document.getElementById('at-field-password');
                const form = document.getElementById('at-pwd-form');
                if (form && email && pwd) {
                    console.log('login detected');
                    email.value = data.email;
                    pwd.value = data.pwd;
                    try {
                        form.submit();
                    } catch (err) {
                        sendToParent('error', { message: 'fail submit' });
                    }
                } else {
                    console.error('fail to get form, pwd or email', form, email, pwd);
                    sendToParent('error', { message: 'fail to get form, pwd or email' });
                }
            }
        });
        sendToParent('inited', {});
        window.onhashchange = needLogin;
    }

    $(document).ready(function () {
        initMessagesIframe();
    });
</script>
</body>